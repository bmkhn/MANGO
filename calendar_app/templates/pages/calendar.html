{% extends "base_internal.html" %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Calendar</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;700&family=Inter:wght@300;400;700&display=swap" rel="stylesheet">

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', sans-serif;
        background: #D9D9D9;
    }

    /* --- MAIN CONTAINER --- */
    #calendar-wrapper {
        display: flex;
        width: 100%;
        background: white;
        border-bottom: 1px solid rgba(0,0,0,0.3);
    }

    /* --- LEFT SIDEBAR --- */
    #calendar-sidebar-left {
        width: 250px;
        background: #D9D9D9;
        padding-top: 30px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 25px;
        box-sizing: border-box;
    }

    #calendar-sidebar-left h2 {
        font-size: 24px;
        font-weight: 400;
        margin: 0;
        text-align: center;
    }

    #year-selector {
        font-size: 24px;
        font-weight: 300;
        padding: 5px 10px;
        border-radius: 6px;
        border: none;
        background: none;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: none;
    }

    #month-selector {
        list-style: none;
        display: flex;
        flex-direction: column;
        width: 100%;
        padding: 0;
        margin: 0;
    }

    #month-selector li {
        font-size: 16px;
        font-weight: 300;
        padding: 20px 0 20px 40px;
        cursor: pointer;
        border-top: 0.8px solid rgba(0, 0, 0, 0.5);
    }

    #month-selector li:hover {
        background: #bfbfbf;
    }

    #month-selector li.active {
        background: #1A1A1A;
        color: white;
    }

    /* --- CENTER CALENDAR --- */
    #calendar-container {
        flex-grow: 1;
        padding: 20px;
    }

    #month-name {
        font-size: 32px;
        font-weight: 400;
        text-align: center;
        margin-bottom: 20px;
    }

    .weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        font-size: 15px;
        font-weight: 400;
        margin-bottom: 10px;
    }

    .weekdays div {
        padding: 5px 0;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }

    .calendar-day {
        border: 1px solid #ccc;
        padding: 10px;
        min-height: 60px;
        cursor: pointer;
        border-radius: 6px;
        text-align: center;
    }

    .calendar-day:hover {
        background: #e6e6e6;
    }


    /* --- RIGHT SIDEBAR --- */
    #calendar-sidebar-right {
        width: 250px;
        background: #1A1A1A;
        color: white;
        padding: 40px;
        box-sizing: border-box;
    }

    #calendar-sidebar-right h2 {
        font-size: 30px;
        font-weight: 500;
        margin-bottom: 25px;
    }

    #event-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    #event-list li {
        margin-bottom: 25px;
        cursor: pointer;
    }

    #event-list h3 {
        font-size: 15px;
        font-weight: 500;
        margin: 0;
    }

    #event-list h4 {
        font-size: 20px;
        font-weight: 500;
        margin: 5px 0 0 15px;
        position: relative;
    }

    #event-list h4::before {
        content: "‚Ä¢";
        position: absolute;
        left: -15px;
        color: #fff;
    }

    /* --- MODAL --- */
    .modal {
        display:none;
        position: fixed;
        z-index:1000;
        inset:0;
        background: rgba(0,0,0,0.5);
        justify-content:center;
        align-items:center;
    }
    .modal-content {
        background:#fff;
        width:600px;
        max-width:calc(100% - 40px);
        height:500px;
        max-height:500px;
        padding:60px;
        border-radius:16px;
        display:flex;
        flex-direction:column;
        gap:20px;
        position:relative;
        overflow-y:auto;
        box-sizing:border-box;
    }

    .close-btn, .edit-btn, .delete-btn {
        position: absolute;
        top: 25px;
        font-size: 24px;
        cursor: pointer;
    }

    .close-btn { right: 25px; }
    .edit-btn { right: 60px; }
    .delete-btn { right: 95px; }

    .event-title {
        font-family: 'Inter', sans-serif;
        font-size: 40px;
        border: none;
        border-bottom: 1px solid #000;
        outline: none;
        color: #888;
    }

    .event-title::placeholder {
        color: #aaa;
    }

    .inline {
        display: inline-flex;
        align-items: center;
        gap: 10px;
    }

    .section-line {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .label {
        font-size: 20px;
    }

    .field-input {
        width: 100%;
        font-size: 20px;
        border: none;
        border-bottom: 1px solid #000;
        outline: none;
        padding: 6px 0;
        color: #888;
    }

    .field-input::placeholder {
        color: #aaa;
    }

    .date-time-row {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
        font-size: 24px;
    }

    .divider {
        width: 1px;
        height: 24px;
        background: rgba(0, 0, 0, 0.2);
    }

    .time-select {
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .time-select select {
        font-size: 18px;
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
        outline: none;
        background: #fff;
    }

    .participants-row {
        display: inline-flex;
        align-items: center;
        gap: 10px;
    }

    .add-participant {
        border: none;
        background: #245F3E;
        color: #fff;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        font-size: 20px;
        cursor: pointer;
        line-height: 32px;
    }

    .event-notes {
        width: 100%;
        min-height: 120px;
        border: 1px solid #ccc;
        border-radius: 8px;
        resize: vertical;
        font-size: 16px;
        padding: 8px;
    }

    .add-event-btn {
        align-self: center;
        font-family: 'Inter', sans-serif;
        font-size: 20px;
        background: #245F3E;
        color: #fff;
        border: none;
        border-radius: 24px;
        padding: 12px 32px;
        cursor: pointer;
    }

</style>

</head>
<body>

<div id="calendar-wrapper">
    <!-- LEFT -->
    <div id="calendar-sidebar-left">
        <h2>My Calendar</h2>
        <select id="year-selector"></select>
        <ul id="month-selector">
            <li data-month="0">January</li><li data-month="1">February</li>
            <li data-month="2">March</li><li data-month="3">April</li>
            <li data-month="4">May</li><li data-month="5">June</li>
            <li data-month="6">July</li><li data-month="7">August</li>
            <li data-month="8">September</li><li data-month="9">October</li>
            <li data-month="10">November</li><li data-month="11">December</li>
        </ul>
    </div>

    <!-- CENTER -->
    <div id="calendar-container">
        <h2 id="month-name"></h2>
        <div class="weekdays">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
        </div>
        <div id="calendar" class="calendar-grid"></div>
    </div>

    <!-- RIGHT -->
    <div id="calendar-sidebar-right">
        <h2>Events</h2>
        <ul id="event-list"><li>No events this month.</li></ul>
    </div>
</div>

<!-- Add Event Modal -->
<div id="add-event-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="close-add-event">&times;</span>
    <input type="text" class="event-title" id="event-title" placeholder="Title" />

    <!-- Date + Time -->
    <div class="date-time-row">
        <div class="inline"><span>üìÖ</span><span id="selected-event-date">‚Äî</span></div>
        <span class="divider"></span>
        <div class="time-select">
            <select id="time-hour">
                <option>1</option><option>2</option><option>3</option><option>4</option>
                <option>5</option><option>6</option><option>7</option><option>8</option>
                <option selected>9</option><option>10</option><option>11</option><option>12</option>
            </select>:
            <select id="time-minute">
                <option>00</option><option>15</option><option selected>30</option><option>45</option>
            </select>
            <select id="time-ampm">
                <option selected>AM</option><option>PM</option>
            </select>
        </div>
    </div>

    <!-- Location -->
    <div>
      <div class="section-line"><span>üìç</span><span class="label">Location</span></div>
      <input type="text" id="event-location" class="field-input" placeholder="Add a location" />
    </div>

    <!-- Participants -->
    <div>
      <div class="section-line"><span>üë•</span><span class="label">Add to Other's Calendar</span></div>
      <div class="participants-row"><span>üë§</span><button type="button" class="add-participant">Ôºã</button></div>
    </div>

    <!-- Notes -->
    <div>
      <div class="section-line"><span>üìù</span><span class="label">Add Notes</span></div>
      <textarea id="event-notes" class="event-notes" placeholder=""></textarea>
    </div>

    <!-- Add Event -->
    <button id="add-event-btn" class="add-event-btn">Add Event</button>
  </div>
</div>

<!-- Event Details Modal -->
<div id="event-details-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="close-event-details">&times;</span>
    <span class="edit-btn" id="edit-event">‚úé</span>
    <span class="delete-btn" id="delete-event">üóëÔ∏è</span>

    <h2 class="event-title" id="details-title"></h2>

    <div class="date-time-row">
        <div class="inline"><span>üìÖ</span><span id="details-date">‚Äî</span></div>
        <span class="divider"></span>
        <div class="time-select">
            <span id="details-time">‚Äî</span>
        </div>
    </div>

    <div>
      <div class="section-line"><span>üìç</span><span class="label">Location</span></div>
      <span id="details-location">‚Äî</span>
    </div>

    <div>
      <div class="section-line"><span>üë•</span><span class="label">Participants</span></div>
      <span id="details-participants">‚Äî</span>
    </div>

    <div>
      <div class="section-line"><span>üìù</span><span class="label">Notes</span></div>
      <span id="details-notes">‚Äî</span>
    </div>
  </div>
</div>

<script>
let events = {};
const calendar = document.getElementById('calendar');
const eventList = document.getElementById('event-list');
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth();
let selectedDate = null;

// Populate year dropdown (current-10 to current+10)
const yearSelector = document.getElementById("year-selector");
for(let y=currentYear-10;y<=currentYear+10;y++){
    const opt=document.createElement("option");
    opt.value=y; opt.textContent=y;
    if(y===currentYear) opt.selected=true;
    yearSelector.appendChild(opt);
}

// Month click
document.querySelectorAll('#month-selector li').forEach(li=>{
    li.onclick=()=>{
        currentMonth=parseInt(li.dataset.month);
        renderCalendar(currentYear,currentMonth);
        fetchEvents();
        document.querySelectorAll('#month-selector li').forEach(l=>l.classList.remove('active'));
        li.classList.add('active');
    };
});

// Set initial active month
document.querySelectorAll('#month-selector li')[currentMonth].classList.add('active');

yearSelector.onchange=()=>{currentYear=parseInt(yearSelector.value); renderCalendar(currentYear,currentMonth); fetchEvents();};

function renderCalendar(year,month){
    const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];
    document.getElementById('month-name').textContent=monthNames[month];
    calendar.innerHTML='';
    const firstDay=new Date(year,month,1).getDay();
    const daysInMonth=new Date(year,month+1,0).getDate();
    for(let i=0;i<firstDay;i++){ calendar.appendChild(document.createElement('div')); }
    for(let d=1;d<=daysInMonth;d++){
        const cell=document.createElement('div');
        const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        cell.className='calendar-day';
        cell.textContent=d;
        cell.dataset.date=dateStr;
        if(events[dateStr]){ cell.style.backgroundColor="#7B7B7B"; cell.style.color="white"; }
        calendar.appendChild(cell);

        // If day has events, clicking opens event details modal
        cell.addEventListener('click', ()=>{
            selectedDate=dateStr;
            if(events[dateStr] && events[dateStr].length>0){
                showEventDetails(events[dateStr][0]); // show first event for simplicity
            } else {
                const dt=new Date(selectedDate+'T00:00:00');
                selectedEventDateEl.textContent=dt.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});
                addEventModal.style.display='flex';
            }
        });
    }
}

// --- Add Event Modal ---
const addEventModal = document.getElementById('add-event-modal');
const closeAddEvent = document.getElementById('close-add-event');
const selectedEventDateEl = document.getElementById('selected-event-date');
const hourSel=document.getElementById('time-hour');
const minSel=document.getElementById('time-minute');
const apSel=document.getElementById('time-ampm');

closeAddEvent.addEventListener('click',()=>{addEventModal.style.display='none';});
addEventModal.addEventListener('click',e=>{if(e.target===addEventModal)addEventModal.style.display='none';});
document.addEventListener('keydown',e=>{if(e.key==='Escape')addEventModal.style.display='none';});

document.getElementById('add-event-btn').addEventListener('click',()=>{
    const title=document.getElementById('event-title').value.trim();
    const location=document.getElementById('event-location').value.trim();
    const notes=document.getElementById('event-notes').value.trim();
    if(!selectedDate||!title){ alert('Select date and enter title'); return; }
    fetch('/api/events/add/',{
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken':getCSRFToken()},
        body:JSON.stringify({title:title,date:selectedDate,location:location,notes:notes})
    }).then(r=>r.json()).then(resp=>{
        if(resp.status==='success'){ addEventModal.style.display='none'; fetchEvents(); }
        else{ alert('Error: '+JSON.stringify(resp.errors||resp)); }
    }).catch(err=>alert('Network error: '+err.message));
});

// --- Event Details Modal ---
const eventDetailsModal = document.getElementById('event-details-modal');
const closeEventDetails = document.getElementById('close-event-details');
const editEventBtn = document.getElementById('edit-event');
const deleteEventBtn = document.getElementById('delete-event');

closeEventDetails.addEventListener('click',()=>{eventDetailsModal.style.display='none';});
eventDetailsModal.addEventListener('click',e=>{if(e.target===eventDetailsModal)eventDetailsModal.style.display='none';});
document.addEventListener('keydown',e=>{if(e.key==='Escape')eventDetailsModal.style.display='none';});

function showEventDetails(ev){
    document.getElementById('details-title').textContent = ev.title;
    document.getElementById('details-date').textContent = new Date(ev.date+'T00:00:00').toLocaleDateString();
    document.getElementById('details-time').textContent = ev.start || '‚Äî';
    document.getElementById('details-location').textContent = ev.location || '‚Äî';
    document.getElementById('details-participants').textContent = ev.participants || '‚Äî';
    document.getElementById('details-notes').textContent = ev.notes || '‚Äî';
    eventDetailsModal.style.display='flex';
}

editEventBtn.addEventListener('click',()=>{
    eventDetailsModal.style.display='none';
    selectedEventDate=events[selectedDate][0].date;
    selectedEventDateEl.textContent=new Date(selectedDate+'T00:00:00').toLocaleDateString();
    document.getElementById('event-title').value=events[selectedDate][0].title;
    document.getElementById('event-location').value=events[selectedDate][0].location;
    document.getElementById('event-notes').value=events[selectedDate][0].notes;
    addEventModal.style.display='flex';
});

deleteEventBtn.addEventListener('click',()=>{
    if(!confirm('Delete this event?')) return;
    fetch(`/api/events/delete/${events[selectedDate][0].id}/`,{
        method:'POST',
        headers:{'X-CSRFToken':getCSRFToken()}
    }).then(r=>r.json()).then(resp=>{
        if(resp.status==='success'){ eventDetailsModal.style.display='none'; fetchEvents(); }
        else{ alert('Error: '+JSON.stringify(resp)); }
    }).catch(err=>alert('Network error: '+err.message));
});

function fetchEvents(){
    fetch(`/api/events/?year=${currentYear}&month=${currentMonth+1}`).then(r=>r.json()).then(data=>{
        events={}; eventList.innerHTML='';
        if(data.length===0){ eventList.innerHTML='<li>No events this month.</li>'; }
        else{ data.forEach(ev=>{
            const dateKey=ev.date; if(!events[dateKey])events[dateKey]=[]; events[dateKey].push(ev);
            const li=document.createElement('li');
            li.textContent=`${ev.title} (${ev.start}) at ${ev.location}`;
            li.addEventListener('click',()=>{ showEventDetails(ev); });
            eventList.appendChild(li);
        }); }
        renderCalendar(currentYear,currentMonth);
    });
}
function getCSRFToken(){ let v="; "+document.cookie; let p=v.split("; csrftoken="); if(p.length===2)return p.pop().split(";").shift(); }

// --- Initial render ---
renderCalendar(currentYear,currentMonth);
fetchEvents();
</script>
</body>
</html>
{% endblock %}